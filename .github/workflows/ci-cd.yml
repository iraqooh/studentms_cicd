name: Optimized CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  test-backend:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:latest
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: test_db
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password
        options: --health-cmd="mysqladmin ping --silent" --health-interval=10s --health-timeout=5s --health-retries=3
        ports:
          - 3306:3306

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: '**/node_modules'
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install backend dependencies
      run: npm ci --prefix backend

    - name: Create Docker network if not exists
      run: |
        docker network inspect studentms-network >/dev/null 2>&1 || \
        docker network create studentms-network

    - name: Start MySQL container
      run: |
        docker run -d --name mysql-container --network studentms-network \
        -e MYSQL_ROOT_PASSWORD=root_password \
        -e MYSQL_DATABASE=test_db \
        -e MYSQL_USER=test_user \
        -e MYSQL_PASSWORD=test_password \
        --health-cmd="mysqladmin ping --silent" \
        --health-interval=10s --health-timeout=5s --health-retries=5 \
        mysql:latest

    - name: Wait for MySQL to be ready
      run: |
        until [ "$(docker inspect -f {{.State.Health.Status}} mysql-container)" = "healthy" ]; do
          echo "Waiting for MySQL to be ready..."
          sleep 5
        done

    - name: Run backend tests
      env:
        DB_HOST: 127.0.0.1
        DB_PORT: 3306
        DB_USER: test_user
        DB_PASSWORD: test_password
        DB_NAME: test_db
      working-directory: backend
      run: npm test

  test-frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '20'

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: '**/node_modules'
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install frontend dependencies
      run: npm ci --prefix frontend

    - name: Run frontend tests
      working-directory: frontend
      run: npm test

  deploy-backend:
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.docker-cache
          key: ${{ runner.os }}-docker-${{ hashFiles('Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-docker-

      - name: Build and push Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/studentms-app:0.1 . --cache-from /tmp/.docker-cache
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/studentms-app:0.1

      - name: Set up SSH Key with SSH agent
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.EC2_KEY }}

      - name: Deploy backend to EC2
        env:
          EC2_USER: ubuntu
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DB_USER: root
          DB_PASSWORD: my-secret-pw
          DB_NAME: cyber_school
          DB_DIALECT: mysql
          DB_PORT: 3306
        run: |
          ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "\
            docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/studentms-app:0.1 && \
            docker pull mysql:latest && \
            docker network ls | grep studentms-network || docker network create studentms-network && \
            docker stop studentms-app && docker rm studentms-app || true && \
            docker stop mysql-container && docker rm mysql-container || true && \
            docker run -d --name mysql-container --network studentms-network \
              -e MYSQL_ROOT_PASSWORD=${DB_PASSWORD} \
              -e MYSQL_DATABASE=${DB_NAME} \
              mysql:latest && \
            while ! docker exec mysql-container mysqladmin ping --silent; do sleep 2; done && \
            docker run -d --name studentms-app --network studentms-network \
              -e DB_HOST=mysql-container \
              -e DB_USER=${DB_USER} \
              -e DB_PASSWORD=${DB_PASSWORD} \
              -e DB_NAME=${DB_NAME} \
              -e DB_DIALECT=${DB_DIALECT} \
              -e DB_PORT=${DB_PORT} \
              -p 3000:3000 ${{ secrets.DOCKER_HUB_USERNAME }}/studentms-app:0.1 \
          "

  build-and-deploy-frontend:
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          ref: main

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install frontend dependencies
        run: npm ci --prefix frontend

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Cache Netlify build
        uses: actions/cache@v3
        with:
          path: 'frontend/.cache'
          key: ${{ runner.os }}-netlify-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-netlify-

      - name: Install Netlify CLI
        run: npm install -g netlify-cli

      - name: Deploy frontend to Netlify
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        working-directory: frontend
        run: netlify deploy --prod --dir=dist
